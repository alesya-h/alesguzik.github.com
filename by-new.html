<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>type here</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            overflow-y: scroll;
            background-color: black;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: Verdana, Helvetica, Arial, Sans-Serif;
            font-size: 87.5%;
            line-height: 24px;
            color: #464646;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url(stars.png);
            background-position: center;
            filter: opacity(25%);
            pointer-events: none;
        }
        #page {
            filter: invert(1);
            padding: 20px;
        }
        .hidden {
            display: none;
        }

        /* Editor container with two panes */
        .editor-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .editor-pane label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #057cb5;
        }
        .editor-pane textarea {
            flex: 1;
            min-height: 400px;
            background: #dddc;
            font-family: Verdana, Helvetica, Arial, Sans-Serif;
            color: #464646;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .editor-pane textarea:focus {
            background: #ddd;
            outline: none;
        }

        /* Action buttons */
        #action {
            text-align: left;
            margin-bottom: 20px;
        }
        #action button {
            padding: .5em;
            font-size: 1.2em;
            min-width: 2em;
            vertical-align: middle;
            cursor: pointer;
        }
        .button {
            display: inline-block;
            padding: 0 5px;
            background-color: #f0f0f0;
            border: 2px solid #ccc;
            border-radius: 5px;
        }

        /* Keyboard styles */
        #kb-keyboard {
            line-height: 20px;
            font-size: 1em;
        }
        #kb-keyboard button {
            float: left;
            display: block;
            margin: 1px;
            height: 3em;
            text-align: center;
            color: gray;
        }
        #kb-keyboard .kb-label-natural {
            color: #e0115f;
        }
        #kb-keyboard .kb-label-shift {
            color: #057cb5;
        }
        #kb-keyboard .kb-label-natural,
        #kb-keyboard .kb-label-shift {
            margin-top: -5px;
            line-height: 20px;
            text-align: center;
            cursor: default;
        }
        #kb-keyboard .kb-label-reference {
            color: gray;
            font-size: .9em;
            line-height: 12px;
            text-align: left;
            cursor: default;
        }
        #kb-keyboard .kb-recessed span {
            color: #3C0;
        }
        #kb-keyboard .kb-recessed-hover span {
            color: #ffd800;
        }
        #kb-keyboard .kb-clear {
            clear: both;
        }

        /* Collapsible */
        input[type='checkbox'] {
            display: none;
        }
        .wrap-collapsible {
            margin: 1.2rem 0;
        }
        .lbl-toggle {
            display: block;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.2rem;
            text-transform: uppercase;
            text-align: center;
            padding: 1rem;
            color: #757575;
            background: #e4e4e4;
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.25s ease-out;
        }
        .lbl-toggle:hover {
            color: #000;
        }
        .lbl-toggle::before {
            content: ' ';
            display: inline-block;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 5px solid currentColor;
            vertical-align: middle;
            margin-right: .7rem;
            transform: translateY(-2px);
            transition: transform .2s ease-out;
        }
        .toggle:checked + .lbl-toggle::before {
            transform: rotate(90deg) translateX(-3px);
        }
        .collapsible-content {
            max-height: 0px;
            overflow: hidden;
            transition: max-height .25s ease-in-out;
        }
        .toggle:checked + .lbl-toggle + .collapsible-content {
            max-height: 650px;
            overflow: scroll;
        }
        .toggle:checked + .lbl-toggle {
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }
        .collapsible-content .content-inner {
            background: rgba(0, 105, 255, .2);
            border-bottom: 1px solid rgba(0, 105, 255, .45);
            border-bottom-left-radius: 7px;
            border-bottom-right-radius: 7px;
            padding: .5rem 1rem;
        }

        /* Responsive */
        @media only screen and (max-width: 640px) {
            .editor-container {
                flex-direction: column;
            }
            .editor-pane textarea {
                min-height: 200px;
            }
            #kb-keyboard button {
                width: 88px;
            }
            #kb-keyboard .kb-key {
                width: 43px;
            }
        }
        @media only screen and (min-width: 641px) {
            #kb-keyboard {
                width: 630px;
            }
            #kb-keyboard button {
                line-height: 2.75em;
            }
            #kb-keyboard .kb-key {
                width: 40px;
            }
            #kb-keyboard #kb-backspace {
                width: 78px;
            }
            #kb-keyboard #kb-tab {
                width: 62px;
            }
            #kb-keyboard #kb-k25 {
                width: 56px;
            }
            #kb-keyboard #kb-caps-lock {
                width: 76px;
            }
            #kb-keyboard #kb-enter {
                width: 84px;
            }
            #kb-keyboard #kb-left-shift {
                width: 46px;
            }
            #kb-keyboard #kb-right-shift {
                width: 114px;
            }
            #kb-keyboard #kb-space {
                width: 246px;
                text-align: center;
            }
            #kb-keyboard #kb-right-ctrl,
            #kb-keyboard #kb-right-alt,
            #kb-keyboard #kb-escape {
                width: 62px;
            }
            #kb-keyboard #kb-left-ctrl,
            #kb-keyboard #kb-left-alt {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="page">
        <div class="main_content">
            <p id="action">
                <button type="button" id="selectAll">Select All</button>
                <button type="button" id="copy">Copy</button>
                <button type="button" id="undo">Undo</button>
                <button type="button" id="redo">Redo</button>
                <button type="button" id="clearAll">Clear All</button>
                <button type="button" title="Shrink letters" id="shrink">-</button>
                <button type="button" title="Enlarge letters" id="enlarge">+</button>
                <button type="button" title="Russian" onclick="window.location.href='./ru-new.html';">RU</button>
            </p>

            <div class="editor-container">
                <div class="editor-pane">
                    <label>Belarusian Keyboard Input</label>
                    <textarea id="editor" name="editor"></textarea>
                </div>
                <div class="editor-pane">
                    <label>Notes</label>
                    <textarea id="notes" name="notes" placeholder="Type notes here..."></textarea>
                </div>
            </div>

            <div id="keyboard"></div>

            <div class="wrap-collapsible">
                <input id="collapsible" class="toggle" type="checkbox">
                <label for="collapsible" class="lbl-toggle">More Info</label>
                <div class="collapsible-content">
                    <div class="content-inner">
                        <p>This <em>Belarusian Keyboard</em> enables you to easily type Belarusian online without installing a Belarusian keyboard. You can use your computer keyboard or mouse to type Belarusian letters with this online keyboard.</p>
                        <p>Pressing <span class="button">Esc</span> on the Belarusian keyboard layout will toggle the mouse input between virtual QWERTY keyboard and virtual Belarusian keyboard.</p>
                        <p>Press <span class="button">Shift</span> for additional Belarusian letters that are not visible on the keyboard.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // Utility functions
        const util = {
            isMobile: /Android|webOS|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),

            preventDefault: function(event) {
                if (!event) event = window.event;
                event.preventDefault ? event.preventDefault() : (event.returnValue = false);
            },

            getCode: function(event) {
                if (!event) event = window.event;
                if (event.code !== undefined && event.key !== undefined) {
                    return event.code;
                }
                return "Unidentified";
            },

            srcId: function(event, container, tagName) {
                if (!event) event = window.event;
                let target = event.target || event.srcElement;
                if (target.nodeType === 3) target = target.parentNode;
                
                while (target.tagName.toLowerCase() !== tagName) {
                    target = target.parentNode;
                    if (target === container || target.tagName.toLowerCase() === "body") {
                        return null;
                    }
                }
                return target.id;
            },

            insertAtCaret: function(element, text) {
                const start = this.getSelectionStart(element);
                const end = this.getSelectionEnd(element);
                const value = element.value;
                element.value = value.substring(0, start) + text + value.substring(end);
                this.setCaretPosition(element, start + text.length, 0);
            },

            deleteAtCaret: function(element, before, after) {
                const start = this.getSelectionStart(element);
                const end = this.getSelectionEnd(element);
                const length = element.value.length;
                
                if (before > start) before = start;
                if (end + after > length) after = length - end;
                
                const deleted = element.value.substring(start - before, end + after);
                element.value = element.value.substring(0, start - before) + element.value.substring(end + after);
                this.setCaretPosition(element, start - before, 0);
                return deleted;
            },

            getSelectionStart: function(element) {
                element.focus();
                if (element.selectionStart !== undefined) {
                    return element.selectionStart;
                }
                return 0;
            },

            getSelectionEnd: function(element) {
                element.focus();
                if (element.selectionEnd !== undefined) {
                    return element.selectionEnd;
                }
                return element.value.length;
            },

            setCaretPosition: function(element, start, length) {
                element.focus();
                if (element.setSelectionRange) {
                    element.setSelectionRange(start, start + length);
                } else if (element.createTextRange) {
                    const range = element.createTextRange();
                    range.collapse(true);
                    range.moveEnd("character", start + length);
                    range.moveStart("character", start);
                    range.select();
                }
            },

            addListener: function(element, event, handler) {
                if (element.addEventListener) {
                    element.addEventListener(event, handler, false);
                } else if (element.attachEvent) {
                    element.attachEvent("on" + event, handler);
                } else {
                    element["on" + event] = handler;
                }
            }
        };

        // Keyboard layout definition
        const keyboard = {
            // Keyboard row definitions
            keyMap: [
                ["Backquote", "Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0", "Minus", "Equal", "Backspace"],
                ["Tab", "KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight", "Backslash"],
                ["CapsLock", "KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote", "Enter"],
                ["ShiftLeft", "KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash", "ShiftRight"],
                ["ControlLeft", "AltLeft", "Space", "Escape", "AltRight", "ControlRight"]
            ],

            // Map button IDs to key codes
            buttonIdMap: {
                "kb-k0": "Backquote", "kb-k1": "Digit1", "kb-k2": "Digit2", "kb-k3": "Digit3",
                "kb-k4": "Digit4", "kb-k5": "Digit5", "kb-k6": "Digit6", "kb-k7": "Digit7",
                "kb-k8": "Digit8", "kb-k9": "Digit9", "kb-k10": "Digit0", "kb-k11": "Minus",
                "kb-k12": "Equal", "kb-backspace": "Backspace", "kb-tab": "Tab",
                "kb-k13": "KeyQ", "kb-k14": "KeyW", "kb-k15": "KeyE", "kb-k16": "KeyR",
                "kb-k17": "KeyT", "kb-k18": "KeyY", "kb-k19": "KeyU", "kb-k20": "KeyI",
                "kb-k21": "KeyO", "kb-k22": "KeyP", "kb-k23": "BracketLeft", "kb-k24": "BracketRight",
                "kb-k25": "Backslash", "kb-caps-lock": "CapsLock", "kb-k26": "KeyA", "kb-k27": "KeyS",
                "kb-k28": "KeyD", "kb-k29": "KeyF", "kb-k30": "KeyG", "kb-k31": "KeyH",
                "kb-k32": "KeyJ", "kb-k33": "KeyK", "kb-k34": "KeyL", "kb-k35": "Semicolon",
                "kb-k36": "Quote", "kb-enter": "Enter", "kb-left-shift": "ShiftLeft",
                "kb-k37": "KeyZ", "kb-k38": "KeyX", "kb-k39": "KeyC", "kb-k40": "KeyV",
                "kb-k41": "KeyB", "kb-k42": "KeyN", "kb-k43": "KeyM", "kb-k44": "Comma",
                "kb-k45": "Period", "kb-k46": "Slash", "kb-right-shift": "ShiftRight",
                "kb-left-ctrl": "ControlLeft", "kb-left-alt": "AltLeft",
                "kb-space": "Space", "kb-escape": "Escape", "kb-right-alt": "AltRight",
                "kb-right-ctrl": "ControlRight"
            },

            // Map key codes to button IDs
            codeButtonIdMap: {
                "Backquote": "kb-k0", "Digit1": "kb-k1", "Digit2": "kb-k2", "Digit3": "kb-k3",
                "Digit4": "kb-k4", "Digit5": "kb-k5", "Digit6": "kb-k6", "Digit7": "kb-k7",
                "Digit8": "kb-k8", "Digit9": "kb-k9", "Digit0": "kb-k10", "Minus": "kb-k11",
                "Equal": "kb-k12", "Backspace": "kb-backspace", "Tab": "kb-tab",
                "KeyQ": "kb-k13", "KeyW": "kb-k14", "KeyE": "kb-k15", "KeyR": "kb-k16",
                "KeyT": "kb-k17", "KeyY": "kb-k18", "KeyU": "kb-k19", "KeyI": "kb-k20",
                "KeyO": "kb-k21", "KeyP": "kb-k22", "BracketLeft": "kb-k23", "BracketRight": "kb-k24",
                "Backslash": "kb-k25", "CapsLock": "kb-caps-lock", "KeyA": "kb-k26", "KeyS": "kb-k27",
                "KeyD": "kb-k28", "KeyF": "kb-k29", "KeyG": "kb-k30", "KeyH": "kb-k31",
                "KeyJ": "kb-k32", "KeyK": "kb-k33", "KeyL": "kb-k34", "Semicolon": "kb-k35",
                "Quote": "kb-k36", "Enter": "kb-enter", "ShiftLeft": "kb-left-shift",
                "KeyZ": "kb-k37", "KeyX": "kb-k38", "KeyC": "kb-k39", "KeyV": "kb-k40",
                "KeyB": "kb-k41", "KeyN": "kb-k42", "KeyM": "kb-k43", "Comma": "kb-k44",
                "Period": "kb-k45", "Slash": "kb-k46", "ShiftRight": "kb-right-shift",
                "ControlLeft": "kb-left-ctrl", "AltLeft": "kb-left-alt",
                "Space": "kb-space", "Escape": "kb-escape", "AltRight": "kb-right-alt",
                "ControlRight": "kb-right-ctrl"
            },

            // Belarusian character mappings
            // Differences from Russian:
            // - KeyO: ў/Ў (short u) instead of щ/Щ
            // - KeyB: і/І (dotted i) instead of и/И
            // - BracketRight: ' (apostrophe) instead of ъ/Ъ
            charMap: {
                natural: {
                    Backquote: "ё", Digit1: "1", Digit2: "2", Digit3: "3", Digit4: "4", Digit5: "5",
                    Digit6: "6", Digit7: "7", Digit8: "8", Digit9: "9", Digit0: "0", Minus: "-", Equal: "=",
                    KeyQ: "й", KeyW: "ц", KeyE: "у", KeyR: "к", KeyT: "е", KeyY: "н", KeyU: "г",
                    KeyI: "ш", KeyO: "ў", KeyP: "з", BracketLeft: "х", BracketRight: "'", Backslash: "\\",
                    KeyA: "ф", KeyS: "ы", KeyD: "в", KeyF: "а", KeyG: "п", KeyH: "р", KeyJ: "о",
                    KeyK: "л", KeyL: "д", Semicolon: "ж", Quote: "э",
                    KeyZ: "я", KeyX: "ч", KeyC: "с", KeyV: "м", KeyB: "і", KeyN: "т", KeyM: "ь",
                    Comma: "б", Period: "ю", Slash: ".", Space: " "
                },
                shift: {
                    Backquote: "Ё", Digit1: "!", Digit2: '"', Digit3: "№", Digit4: ";", Digit5: "%",
                    Digit6: ":", Digit7: "?", Digit8: "*", Digit9: "(", Digit0: ")", Minus: "_", Equal: "+",
                    KeyQ: "Й", KeyW: "Ц", KeyE: "У", KeyR: "К", KeyT: "Е", KeyY: "Н", KeyU: "Г",
                    KeyI: "Ш", KeyO: "Ў", KeyP: "З", BracketLeft: "Х", BracketRight: "'", Backslash: "/",
                    KeyA: "Ф", KeyS: "Ы", KeyD: "В", KeyF: "А", KeyG: "П", KeyH: "Р", KeyJ: "О",
                    KeyK: "Л", KeyL: "Д", Semicolon: "Ж", Quote: "Э",
                    KeyZ: "Я", KeyX: "Ч", KeyC: "С", KeyV: "М", KeyB: "І", KeyN: "Т", KeyM: "Ь",
                    Comma: "Б", Period: "Ю", Slash: ",", Space: " "
                }
            },

            // QWERTY reference map for when keyboard is in "recessed" mode
            referenceMap: {
                Backquote: "`", Digit1: "1", Digit2: "2", Digit3: "3", Digit4: "4", Digit5: "5",
                Digit6: "6", Digit7: "7", Digit8: "8", Digit9: "9", Digit0: "0", Minus: "-", Equal: "=",
                KeyQ: "q", KeyW: "w", KeyE: "e", KeyR: "r", KeyT: "t", KeyY: "y", KeyU: "u",
                KeyI: "i", KeyO: "o", KeyP: "p", BracketLeft: "[", BracketRight: "]", Backslash: "\\",
                KeyA: "a", KeyS: "s", KeyD: "d", KeyF: "f", KeyG: "g", KeyH: "h", KeyJ: "j",
                KeyK: "k", KeyL: "l", Semicolon: ";", Quote: "'",
                KeyZ: "z", KeyX: "x", KeyC: "c", KeyV: "v", KeyB: "b", KeyN: "n", KeyM: "m",
                Comma: ",", Period: ".", Slash: "/"
            },

            // State
            shift: false,
            capsLock: false,
            recessed: false,  // When true, keyboard types in QWERTY mode

            // Handle physical keyboard key down
            keydown: function(event) {
                // Allow keyboard shortcuts (Ctrl+C, Ctrl+V, etc.)
                if (event.ctrlKey || event.altKey || event.metaKey) {
                    return;
                }

                const code = util.getCode(event);
                if (code === "Unidentified") return;

                // Escape toggles between Cyrillic and QWERTY mode
                if (code === "Escape") {
                    this.recessed = !this.recessed;
                    this.updateRecessed();
                    util.preventDefault(event);
                    return;
                }

                // If in QWERTY mode, let browser handle everything else
                if (this.recessed) {
                    return;
                }

                // Handle modifier keys
                if (code === "ShiftLeft" || code === "ShiftRight") {
                    this.shift = true;
                    this.updateLabels();
                    return;
                }

                if (code === "CapsLock") {
                    this.capsLock = !this.capsLock;
                    this.updateLabels();
                    return;
                }

                // Handle special keys
                if (code === "Tab") {
                    return; // Let browser handle Tab for navigation
                }

                if (code === "Backspace" || code === "Enter") {
                    return; // Let browser handle these
                }

                // Get the character to insert
                let char = this.charMap.natural[code];
                if (this.shift || this.capsLock) {
                    char = this.charMap.shift[code];
                }

                if (char !== undefined) {
                    util.preventDefault(event);
                    util.insertAtCaret(editor.element, char);
                }
            },

            // Handle physical keyboard key up
            keyup: function(event) {
                if (this.recessed) return;

                const code = util.getCode(event);
                if (code === "Unidentified") return;

                if (code === "ShiftLeft" || code === "ShiftRight") {
                    this.shift = false;
                    this.updateLabels();
                }
            },

            // Handle virtual keyboard button mouse down
            buttonMouseDown: function(event) {
                const buttonId = util.srcId(event, document.getElementById("kb-keyboard"), "button");
                if (buttonId === null) return;

                const code = this.buttonIdMap[buttonId];
                if (code === undefined) return;

                // Handle modifier keys
                if (code === "ShiftLeft" || code === "ShiftRight") {
                    this.shift = true;
                    this.updateLabels();
                    return;
                }

                if (code === "CapsLock") {
                    this.capsLock = !this.capsLock;
                    this.updateLabels();
                    return;
                }

                // Ignore these keys on virtual keyboard
                if (code === "ControlLeft" || code === "ControlRight" || 
                    code === "AltLeft" || code === "AltRight") {
                    return;
                }

                if (code === "Escape") {
                    this.recessed = !this.recessed;
                    this.updateRecessed();
                    return;
                }

                if (code === "Tab") {
                    util.insertAtCaret(editor.element, "\t");
                    return;
                }

                if (code === "Backspace") {
                    util.deleteAtCaret(editor.element, 1, 0);
                    return;
                }

                if (code === "Enter") {
                    util.insertAtCaret(editor.element, "\n");
                    return;
                }

                // Get character to insert
                let char = this.charMap.natural[code];
                if (this.shift || this.capsLock) {
                    char = this.charMap.shift[code];
                }

                // In QWERTY mode, use reference map
                if (this.recessed) {
                    char = this.referenceMap[code];
                    if (this.shift || this.capsLock) {
                        char = char.toUpperCase();
                    }
                }

                if (char !== undefined) {
                    util.insertAtCaret(editor.element, char);
                }
            },

            // Handle virtual keyboard button mouse up
            buttonMouseUp: function(event) {
                const buttonId = util.srcId(event, document.getElementById("kb-keyboard"), "button");
                if (buttonId === null) return;

                if (buttonId === "kb-left-shift" || buttonId === "kb-right-shift") {
                    this.shift = false;
                    this.updateLabels();
                }
            },

            // Update keyboard labels based on shift/caps state
            updateLabels: function() {
                for (const row of this.keyMap) {
                    for (const code of row) {
                        const buttonId = this.codeButtonIdMap[code];
                        const button = document.getElementById(buttonId);
                        if (button) {
                            const spans = button.getElementsByTagName("span");
                            if (spans.length >= 2) {
                                if (this.shift || this.capsLock) {
                                    spans[0].style.display = "none";
                                    spans[1].style.display = "block";
                                } else {
                                    spans[0].style.display = "block";
                                    spans[1].style.display = "none";
                                }
                            }
                        }
                    }
                }
            },

            // Update keyboard appearance for QWERTY mode
            updateRecessed: function() {
                const keyboardEl = document.getElementById("kb-keyboard");
                keyboardEl.className = this.recessed ? "kb-recessed" : "";
            },

            // Build the virtual keyboard HTML
            build: function() {
                let html = "";

                for (const row of this.keyMap) {
                    for (const code of row) {
                        const buttonId = this.codeButtonIdMap[code];
                        const natural = this.charMap.natural[code] || "";
                        const shift = this.charMap.shift[code] || "";

                        // Special keys
                        if (code === "Backspace") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">&larr;</button>`;
                        } else if (code === "Tab") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Tab</button>`;
                        } else if (code === "CapsLock") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Caps</button>`;
                        } else if (code === "Enter") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Enter</button>`;
                        } else if (code === "ShiftLeft" || code === "ShiftRight") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Shift</button>`;
                        } else if (code === "ControlLeft" || code === "ControlRight") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Ctrl</button>`;
                        } else if (code === "AltLeft" || code === "AltRight") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Alt</button>`;
                        } else if (code === "Space") {
                            html += `<button type="button" id="${buttonId}" class="kb-key"></button>`;
                        } else if (code === "Escape") {
                            html += `<button type="button" id="${buttonId}" class="kb-key">Esc</button>`;
                        } else {
                            html += `<button type="button" id="${buttonId}" class="kb-key">` +
                                    `<span class="kb-label-natural">${natural}</span>` +
                                    `<span class="kb-label-shift" style="display:none">${shift}</span>` +
                                    `</button>`;
                        }
                    }
                    html += '<div class="kb-clear"></div>';
                }

                document.getElementById("keyboard").innerHTML = `<div id="kb-keyboard">${html}</div>`;

                // Attach event listeners
                const keyboardEl = document.getElementById("kb-keyboard");
                util.addListener(keyboardEl, "mousedown", this.buttonMouseDown.bind(this));
                util.addListener(keyboardEl, "mouseup", this.buttonMouseUp.bind(this));
            }
        };

        // Editor management
        const editor = {
            element: null,
            history: [],
            historyIndex: -1,

            init: function() {
                this.element = document.getElementById("editor");
                keyboard.build();

                // Attach keyboard events to editor
                util.addListener(this.element, "keydown", keyboard.keydown.bind(keyboard));
                util.addListener(this.element, "keyup", keyboard.keyup.bind(keyboard));

                // Button handlers
                util.addListener(document.getElementById("selectAll"), "click", () => {
                    this.element.select();
                });

                util.addListener(document.getElementById("copy"), "click", () => {
                    this.element.select();
                    document.execCommand("copy");
                });

                util.addListener(document.getElementById("clearAll"), "click", () => {
                    this.element.value = "";
                });

                util.addListener(document.getElementById("shrink"), "click", () => {
                    const size = parseInt(window.getComputedStyle(this.element).fontSize);
                    this.element.style.fontSize = (size - 2) + "px";
                });

                util.addListener(document.getElementById("enlarge"), "click", () => {
                    const size = parseInt(window.getComputedStyle(this.element).fontSize);
                    this.element.style.fontSize = (size + 2) + "px";
                });

                // Undo/Redo functionality
                util.addListener(this.element, "input", () => {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                    this.history.push(this.element.value);
                    this.historyIndex = this.history.length - 1;
                });

                util.addListener(document.getElementById("undo"), "click", () => {
                    if (this.historyIndex > 0) {
                        this.historyIndex--;
                        this.element.value = this.history[this.historyIndex];
                    }
                });

                util.addListener(document.getElementById("redo"), "click", () => {
                    if (this.historyIndex < this.history.length - 1) {
                        this.historyIndex++;
                        this.element.value = this.history[this.historyIndex];
                    }
                });

                // Initialize history
                this.history.push(this.element.value);
                this.historyIndex = 0;
            }
        };

        // Initialize on page load
        util.addListener(window, "load", () => editor.init());
    })();
    </script>
</body>
</html>
